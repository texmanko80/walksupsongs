<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Little League Walk-Up Songs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1e3a8a;
            margin-bottom: 8px;
            font-size: 28px;
        }

        .subtitle {
            color: #64748b;
            font-size: 14px;
        }

        .spotify-auth {
            background: white;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .spotify-auth h2 {
            color: #1e3a8a;
            margin-bottom: 16px;
        }

        .spotify-auth p {
            color: #64748b;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .btn-spotify {
            background: #1DB954;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-spotify:hover {
            background: #1ed760;
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .add-player-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-player-section h2 {
            color: #1e3a8a;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            color: #475569;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-results {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .song-info {
            font-size: 14px;
        }

        .song-title {
            font-weight: 600;
            color: #1e293b;
        }

        .song-artist {
            color: #64748b;
            font-size: 13px;
        }

        .selected-song {
            margin-top: 12px;
            padding: 12px;
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            display: none;
        }

        .selected-song.active {
            display: block;
        }

        .timestamp-selector {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .timestamp-label {
            font-size: 13px;
            color: #475569;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .timestamp-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timestamp-input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .btn-preview {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-preview:hover {
            background: #7c3aed;
        }

        .timestamp-hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .lineup-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .lineup-section h2 {
            color: #1e3a8a;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .player-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-number {
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .player-song {
            color: #64748b;
            font-size: 13px;
        }

        .player-timestamp {
            color: #8b5cf6;
            font-size: 12px;
            font-weight: 600;
            margin-top: 2px;
        }

        .player-actions {
            display: flex;
            gap: 8px;
        }

        .btn-play {
            background: #1DB954;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-play:hover {
            background: #1ed760;
        }

        .btn-play.playing {
            background: #dc2626;
        }

        .btn-play.playing:hover {
            background: #ef4444;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-move {
            background: #64748b;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-move:hover {
            background: #475569;
        }

        .btn-move:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öæ Walk-Up Songs</h1>
            <p class="subtitle">Little League Batting Lineup</p>
        </div>

        <div class="spotify-auth" id="authSection">
            <h2>Connect to Spotify</h2>
            <p>To use this app, you'll need to connect your Spotify Premium account. This allows us to play walk-up song clips during the game.</p>
            <button class="btn-spotify" onclick="loginWithSpotify()">Connect Spotify</button>
        </div>

        <div class="main-content" id="mainContent">
            <div class="add-player-section">
                <h2>Add Player</h2>
                <form id="addPlayerForm" onsubmit="handleAddPlayer(event)">
                    <div class="form-group">
                        <label for="playerName">Player Name</label>
                        <input type="text" id="playerName" placeholder="Enter player name" required>
                    </div>
                    <div class="form-group">
                        <label for="songSearch">Search for Song</label>
                        <input type="text" id="songSearch" placeholder="Search songs on Spotify..." oninput="handleSongSearch(event)">
                        <div class="search-results" id="searchResults"></div>
                        <div class="selected-song" id="selectedSong"></div>
                    </div>
                    <button type="submit" class="btn-primary" id="addPlayerBtn" disabled>Add to Lineup</button>
                </form>
            </div>

            <div class="lineup-section">
                <h2>Batting Order</h2>
                <div id="lineup">
                    <div class="empty-state">
                        <p>No players in the lineup yet. Add your first player above!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // Spotify configuration
        const CLIENT_ID = 'YOUR_SPOTIFY_CLIENT_ID'; // User will need to replace this
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'streaming user-read-email user-read-private';

        let accessToken = null;
        let player = null;
        let deviceId = null;
        let currentlyPlaying = null;
        let selectedSong = null;
        let lineup = [];
        let searchTimeout = null;

        // Check for access token in URL
        window.onload = function() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token) {
                accessToken = token;
                window.history.replaceState({}, document.title, window.location.pathname);
                initializeApp();
            }

            // Load saved lineup
            const savedLineup = localStorage.getItem('walkupLineup');
            if (savedLineup) {
                lineup = JSON.parse(savedLineup);
            }
        };

        function loginWithSpotify() {
            if (CLIENT_ID === 'YOUR_SPOTIFY_CLIENT_ID') {
                alert('Please set up your Spotify Client ID first. See instructions in the app.');
                return;
            }
            
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
            window.location.href = authUrl;
        }

        function initializeApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').classList.add('active');
            initializeSpotifyPlayer();
            renderLineup();
        }

        window.onSpotifyWebPlaybackSDKReady = () => {
            if (accessToken) {
                initializeSpotifyPlayer();
            }
        };

        function initializeSpotifyPlayer() {
            player = new Spotify.Player({
                name: 'Walk-Up Songs Player',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.8
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            player.connect();
        }

        async function handleSongSearch(event) {
            const query = event.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    const data = await response.json();
                    displaySearchResults(data.tracks.items);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        }

        function displaySearchResults(tracks) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (tracks.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: #64748b;">No results found</div>';
                resultsDiv.classList.add('active');
                return;
            }

            resultsDiv.innerHTML = tracks.map(track => `
                <div class="search-result-item" onclick='selectSong(${JSON.stringify({
                    id: track.id,
                    uri: track.uri,
                    name: track.name,
                    artist: track.artists[0].name,
                    previewUrl: track.preview_url
                })})'>
                    <div class="song-info">
                        <div class="song-title">${track.name}</div>
                        <div class="song-artist">${track.artists[0].name}</div>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.classList.add('active');
        }

        function selectSong(song) {
            selectedSong = song;
            selectedSong.startTime = 0; // Default start time
            
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('songSearch').value = `${song.name} - ${song.artist}`;
            
            const selectedDiv = document.getElementById('selectedSong');
            selectedDiv.innerHTML = `
                <div class="song-info">
                    <div class="song-title">‚úì ${song.name}</div>
                    <div class="song-artist">${song.artist}</div>
                </div>
                <div class="timestamp-selector">
                    <div class="timestamp-label">Choose start time for 20-second clip:</div>
                    <div class="timestamp-controls">
                        <input type="number" id="startMinutes" class="timestamp-input" min="0" max="9" value="0" placeholder="0"> : 
                        <input type="number" id="startSeconds" class="timestamp-input" min="0" max="59" value="0" placeholder="00">
                        <button type="button" class="btn-preview" onclick="previewTimestamp()">Preview</button>
                    </div>
                    <div class="timestamp-hint">Enter the time where you want the clip to start (e.g., 1:30 for the chorus)</div>
                </div>
            `;
            selectedDiv.classList.add('active');
            
            document.getElementById('addPlayerBtn').disabled = false;
        }

        async function previewTimestamp() {
            if (!selectedSong || !deviceId) return;

            const minutes = parseInt(document.getElementById('startMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('startSeconds').value) || 0;
            const startTimeMs = (minutes * 60 + seconds) * 1000;

            try {
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: [selectedSong.uri],
                        position_ms: startTimeMs
                    })
                });

                // Stop after 20 seconds
                setTimeout(async () => {
                    await fetch(`https://api.spotify.com/v1/me/player/pause`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                }, 20000);
            } catch (error) {
                console.error('Preview error:', error);
                alert('Error previewing song. Make sure Spotify is active on this device.');
            }
        }

        function handleAddPlayer(event) {
            event.preventDefault();
            
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!playerName || !selectedSong) {
                return;
            }

            // Capture the timestamp
            const minutes = parseInt(document.getElementById('startMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('startSeconds').value) || 0;
            const startTime = minutes * 60 + seconds;

            lineup.push({
                name: playerName,
                song: {
                    ...selectedSong,
                    startTime: startTime
                }
            });

            saveLineup();
            renderLineup();

            // Reset form
            document.getElementById('addPlayerForm').reset();
            document.getElementById('selectedSong').classList.remove('active');
            document.getElementById('addPlayerBtn').disabled = true;
            selectedSong = null;
        }

        function renderLineup() {
            const lineupDiv = document.getElementById('lineup');
            
            if (lineup.length === 0) {
                lineupDiv.innerHTML = '<div class="empty-state"><p>No players in the lineup yet. Add your first player above!</p></div>';
                return;
            }

            lineupDiv.innerHTML = lineup.map((player, index) => {
                const startTime = player.song.startTime || 0;
                const minutes = Math.floor(startTime / 60);
                const seconds = startTime % 60;
                const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                return `
                <div class="player-card">
                    <div class="player-number">${index + 1}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-song">${player.song.name} - ${player.song.artist}</div>
                        <div class="player-timestamp">‚è± Starts at ${timeDisplay}</div>
                    </div>
                    <div class="player-actions">
                        <button class="btn-move" onclick="movePlayer(${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                        <button class="btn-move" onclick="movePlayer(${index}, 1)" ${index === lineup.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        <button class="btn-play" id="play-${index}" onclick="playSong(${index})">‚ñ∂ Play</button>
                        <button class="btn-delete" onclick="deletePlayer(${index})">üóë</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function playSong(index) {
            const player = lineup[index];
            const playBtn = document.getElementById(`play-${index}`);

            // Stop current song if playing
            if (currentlyPlaying !== null) {
                const prevBtn = document.getElementById(`play-${currentlyPlaying}`);
                if (prevBtn) {
                    prevBtn.textContent = '‚ñ∂ Play';
                    prevBtn.classList.remove('playing');
                }
                
                if (currentlyPlaying === index) {
                    // If clicking the same song, just stop it
                    await fetch(`https://api.spotify.com/v1/me/player/pause`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    currentlyPlaying = null;
                    return;
                }
            }

            try {
                const startTimeMs = (player.song.startTime || 0) * 1000;
                
                // Play the song from the specified timestamp
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: [player.song.uri],
                        position_ms: startTimeMs
                    })
                });

                currentlyPlaying = index;
                playBtn.textContent = '‚è∏ Stop';
                playBtn.classList.add('playing');

                // Stop after 20 seconds
                setTimeout(async () => {
                    if (currentlyPlaying === index) {
                        await fetch(`https://api.spotify.com/v1/me/player/pause`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        playBtn.textContent = '‚ñ∂ Play';
                        playBtn.classList.remove('playing');
                        currentlyPlaying = null;
                    }
                }, 20000);
            } catch (error) {
                console.error('Playback error:', error);
                alert('Error playing song. Make sure Spotify is active on this device.');
            }
        }

        function movePlayer(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= lineup.length) return;

            const temp = lineup[index];
            lineup[index] = lineup[newIndex];
            lineup[newIndex] = temp;

            saveLineup();
            renderLineup();
        }

        function deletePlayer(index) {
            if (confirm(`Remove ${lineup[index].name} from the lineup?`)) {
                lineup.splice(index, 1);
                saveLineup();
                renderLineup();
            }
        }

        function saveLineup() {
            localStorage.setItem('walkupLineup', JSON.stringify(lineup));
        }
    </script>
</body>
</html>
